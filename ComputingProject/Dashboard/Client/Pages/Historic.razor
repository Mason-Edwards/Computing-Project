@page "/telemetryhistorical"
@using Dashboard.Client.Adapters;
@using Google.Protobuf.WellKnownTypes;
@using Microsoft.Fast.Components.FluentUI
@using Dashboard.Client.Components
@using Dashboard.Shared.GrpcProto
@using Grpc.Core
@using Dashboard.Client.Enums
@using Dashboard.Client.Services
@using Dashboard.Shared.Models
@using System.Text.Json;

@inject IJSRuntime JsRuntime
@inject TelemetryData.TelemetryDataClient TelemetryClient

<PageTitle>Live Telemetry</PageTitle>
<div class="telemetry-container">
    <ButtonBanner OnLoadDataClicked="LoadDataClicked"/>
    <TelemetryDashboard @ref="dashboard" />
    <ParameterList Connection="connection" Recording="recording" OnAddFakeDataLogs="AddFakeDataLogsClicked" OnClearFakeDataLogs="ClearFakeDataLogsClicked" OnAddFakeDataPoints="AddFakeDataPointsClicked"
       OnClearFakeDataPoints="ClearFakeDataPointsClicked" />
    <TelemetryLog @ref="log" />
</div>

@code {
    AsyncServerStreamingCall<Data>? stream;
    HashSet<string>? parameters = new HashSet<string>();

    TelemetryDashboard? dashboard;
    TelemetryLog? log;

    ConnectionStatus connection = ConnectionStatus.Disconnected;
    RecordingStatus recording = RecordingStatus.NotRecoding;

    private Random rnd = new Random();

    // Need to clean this code. More consistent types etc. 
    // There is a bug when the stream is stopped and started again, nothing happens and it needs to be started/stopped multiple times for data to start going through
    // again.

    // Parameter names need to be fixed, where the parameter name and units are shown nicer.

    // gRPC needs to be removed from server side and its easier to just use it straight from the client.
    // CORS needs to be sorted properly.

    public async Task LoadDataClicked()
    {
        // Find out where this logic should live, doing here for now.
        var start = await JsRuntime.InvokeAsync<string>("GetStartDate");
        var end = await JsRuntime.InvokeAsync<string>("GetEndDate");

        var startParsed = DateTimeOffset.Parse(start);
        var startToUnix = startParsed.ToUnixTimeSeconds();

        var endParsed = DateTimeOffset.Parse(end);
        var endToUnix = endParsed.ToUnixTimeSeconds();

        LoadTelemetryDataReply loadedData = await TelemetryClient.LoadTelemetryDataAsync(new LoadTelemetryDataRequest() { Start = startToUnix, End = endToUnix });

        for (int i = 0; i < loadedData.DataList.Count; i++)
        {
            var data = loadedData.DataList.ElementAt(i);
            var dateTime = DateTime.Parse(data.Timestamp);
            var time = ((DateTimeOffset)dateTime).ToUnixTimeMilliseconds();
            if (data.Unit.Equals("log"))
            {
                Parameter p = new Parameter($"{data.Parameter}", 1, "rgb(255, 0, 0)", "rgba(255, 0, 0, 1)");
                ParameterData paramData = new ParameterData(data.Value.ToString(), DateTimeOffset.Parse(data.Timestamp).ToUnixTimeMilliseconds());
                //DateTimeOffset time = DateTimeOffset.Parse(data.Timestamp);
                log.addLog(p, paramData.Value, (DateTimeOffset)dateTime);
            }
            if (!parameters.Contains(data.Parameter))
            {
                var colorString = $"rgb({rnd.Next(256)}, {rnd.Next(256)}, {rnd.Next(256)})";
                Parameter p = new Parameter($"{data.Parameter}", 1, colorString, colorString);
                string pSerialised = JsonSerializer.Serialize(p);
                parameters.Add(data.Parameter);

                await JsRuntime.InvokeAsync<string>("addNewParameter", pSerialised);
            }
            ParameterData pd = new ParameterData(data.Value.ToString(), DateTimeOffset.Parse(data.Timestamp).ToUnixTimeMilliseconds());
            await JsRuntime.InvokeAsync<string>("addData", data.Parameter, pd);
        }

        await JsRuntime.InvokeAsync<string>("scaleChartXAxis");
    }

    public void AddFakeDataLogsClicked()
    {
        //log?.addFakeLogs();
    }

    public void ClearFakeDataLogsClicked()
    {
        log?.clearLogs();
    }

    public void AddFakeDataPointsClicked()
    {

        dashboard?.AddFakeDataPoints();
    }

    public void ClearFakeDataPointsClicked()
    {
        dashboard?.ClearDataPoints();
    }

}